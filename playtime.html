<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Playtime Notification</title>
    <style>
      :root {
        --transition: 0.3s;
        --displaytime: 6s;
        --scale: 1;
        --roundness: 16px;
      }

      body {
        margin: 0;
        padding: 0;
        background: transparent;
        font-family: "Segoe UI", system-ui, sans-serif;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .playtime-container {
        width: 460px;
        border-radius: var(--roundness);
        overflow: hidden;
        background: rgba(20, 22, 28, 0.92);
        color: #fff;
        transform: scale(0) translateY(30px);
        transform-origin: center center;
        opacity: 0;
        will-change: transform, opacity;
      }

      .header-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
      }

      .info-bar {
        display: flex;
        gap: 16px;
        padding: 16px;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      .text-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
      }

      .title {
        font-weight: 700;
        font-size: 18px;
        margin-bottom: 4px;
      }

      .desc {
        font-size: 14px;
        opacity: 0.9;
      }

      @keyframes play-in {
        to {
          transform: scale(var(--scale)) translateY(0);
          opacity: 1;
        }
      }

      @keyframes play-hold {
        to {
          transform: scale(var(--scale)) translateY(0);
          opacity: 1;
        }
      }

      @keyframes play-out {
        to {
          transform: scale(0.85) translateY(18px);
          opacity: 0;
        }
      }

      .playtime-in {
        animation:
          play-in var(--transition) ease-out forwards,
          play-hold calc(var(--displaytime) - var(--transition) * 2) linear
            forwards var(--transition),
          play-out var(--transition) ease-in forwards
            calc(var(--displaytime) - var(--transition));
      }

      .playtime-out {
        animation: play-out var(--transition) ease-in forwards;
      }

      @media (prefers-reduced-motion: reduce) {
        .playtime-in,
        .playtime-out {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="playtime-container" id="playtime-box">
      <img id="header-img" class="header-img" alt="Game Header" />
      <div class="info-bar">
        <div class="text-content">
          <div class="title" id="play-title">Now Playing</div>
          <div class="desc" id="play-desc">Start Playtime!</div>
        </div>
      </div>
    </div>

    <script>
      const ipcRenderer =
        (window.electron && window.electron.ipcRenderer) ||
        window.ipcRenderer ||
        null;

      window.addEventListener("DOMContentLoaded", () => {
        const box = document.getElementById("playtime-box");
        const title = document.getElementById("play-title");
        const desc = document.getElementById("play-desc");
        const header = document.getElementById("header-img");

        let holdTimer = null;
        let closed = false;

        function restart(cls) {
          box.classList.remove("playtime-in", "playtime-out");
          void box.offsetWidth;
          box.classList.add(cls);
        }
        function msDisplayTime() {
          const raw = getComputedStyle(document.documentElement)
            .getPropertyValue("--displaytime")
            .trim();
          return raw.endsWith("ms")
            ? parseFloat(raw)
            : Math.round((parseFloat(raw || "6") || 6) * 1000);
        }
        function closeOnce() {
          if (closed) return;
          closed = true;
          ipcRenderer && ipcRenderer.send("close-playtime-window");
        }

        box.addEventListener("animationend", (ev) => {
          if (ev.animationName === "play-out") closeOnce();
        });

        ipcRenderer?.on("show-playtime", (data) => {
          const d = data || {};
          title.textContent = d.displayName || "Unknown Game";
          desc.textContent = d.description || "Start Playtime!";
          header.src = d.headerUrl || "";
          if (d.scale)
            document.documentElement.style.setProperty("--scale", d.scale);

          closed = false;
          if (holdTimer) {
            clearTimeout(holdTimer);
            holdTimer = null;
          }
          restart("playtime-in");
          holdTimer = setTimeout(() => {
            restart("playtime-out");
          }, msDisplayTime());
        });

        ipcRenderer.on("start-close-animation", (data) => {
          if (data?.scale) {
            document.documentElement.style.setProperty("--scale", data.scale);
          }
          box.classList.remove("playtime-in", "playtime-out");
          void box.offsetWidth;
          box.classList.add("playtime-out");
          const styles = getComputedStyle(document.documentElement);
          const transition =
            parseFloat(styles.getPropertyValue("--transition")) || 0.3;
          setTimeout(
            () => ipcRenderer.send("close-playtime-window"),
            transition * 1000,
          );
        });
      });
    </script>
  </body>
</html>
