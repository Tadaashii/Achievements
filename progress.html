<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css" />
    <meta name="duration" content="5000" />
    <meta width="350" height="100" />
    <title>Progress Notification</title>
    <style>
      :root {
        --transition-in: 280ms;
        --transition-out: 240ms;
        --displaytime: 5000ms;
        --scale: 0.95;
        --roundness: 8px;
        --slide-in: 30px;
        --slide-out: -26px;
        --progress-max-width: 350px;
        --progress-bar-color: lime;
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: transparent;
        font-family: Arial, sans-serif;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
      }

      .progress-notification {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        width: fit-content;
        max-width: min(var(--progress-max-width), calc(100vw - 8px));
        box-sizing: border-box;
        background: rgba(0, 0, 0, 0.75);
        border-radius: var(--roundness);
        padding: 10px 20px;
        color: white;
        transform: scale(0) translateY(var(--slide-in));
        opacity: 0;
      }

      .progress-notification.is-active {
        animation:
          ach-in var(--transition-in) ease-out forwards,
          ach-hold
            calc(var(--displaytime) - var(--transition-in) - var(--transition-out))
            ease forwards var(--transition-in),
          ach-out var(--transition-out) ease-in forwards
            calc(var(--displaytime) - var(--transition-out));
      }

      .progress-notification.is-short {
        --transition-in: 220ms;
        --transition-out: 200ms;
        --scale: 0.97;
        --slide-in: 20px;
        --slide-out: -16px;
      }

      .progress-notification.is-medium {
        --transition-in: 280ms;
        --transition-out: 240ms;
        --scale: 0.95;
        --slide-in: 28px;
        --slide-out: -24px;
      }

      .progress-notification.is-long {
        --transition-in: 340ms;
        --transition-out: 280ms;
        --scale: 0.93;
        --slide-in: 36px;
        --slide-out: -30px;
      }

      .progress-notification.is-complete {
        --progress-bar-color: #ffd54f;
        box-shadow: 0 0 12px rgba(255, 213, 79, 0.35);
      }

      @keyframes ach-in {
        to {
          transform: scale(var(--scale)) translateY(0);
          opacity: 1;
        }
      }

      @keyframes ach-hold {
        to {
          opacity: 1;
          transform: scale(var(--scale)) translateY(0);
        }
      }

      @keyframes ach-out {
        to {
          transform: scale(calc(var(--scale) * 0.9)) translateY(var(--slide-out));
          opacity: 0;
        }
      }

      .progress-icon {
        flex: 0 0 auto;
      }

      .progress-icon img {
        width: 64px;
        height: 64px;
      }

      .progress-text {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .title {
        margin: 0;
        font-size: 16px;
        line-height: 1.25;
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        overflow: hidden;
      }

      .bar-container {
        width: 100%;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #444;
        overflow: hidden;
        margin-top: 5px;
      }

      .progress-fill {
        height: 100%;
        background-color: var(--progress-bar-color);
        transition: width 0.5s ease;
      }
    </style>
  </head>
  <body>
    <div class="progress-notification">
      <div class="progress-icon"><img src="" alt="Icon" /></div>
      <div class="progress-text">
        <div class="title"></div>
        <div class="bar-container">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
        </div>
      </div>
    </div>
    <script src="utils/i18n-ui.js"></script>
    <script>
      (async function () {
        const docEl = document.documentElement;
        const container = document.querySelector(".progress-notification");
        const titleEl = document.querySelector(".title");
        const imgEl = document.querySelector(".progress-icon img");
        const fill = document.querySelector(".progress-fill");
        const metaDur = document.querySelector('meta[name="duration"]');
        const sizeMeta = document.querySelector("meta[width][height]");
        const totalDurationMs = Math.max(0, Number(metaDur?.content || 5000));
        const parsedMaxWidth = Number(sizeMeta?.getAttribute("width") || 350);
        const maxWidth =
          Number.isFinite(parsedMaxWidth) && parsedMaxWidth > 0
            ? parsedMaxWidth
            : 350;
        docEl.style.setProperty("--displaytime", `${totalDurationMs}ms`);
        docEl.style.setProperty("--progress-max-width", `${maxWidth}px`);

        const PROFILE_CLASSES = ["is-short", "is-medium", "is-long", "is-complete"];
        let closeTimer = null;

        const scheduleClose = (delayMs) => {
          if (closeTimer) clearTimeout(closeTimer);
          closeTimer = setTimeout(() => {
            container?.classList.remove("is-active");
            window.api?.closeNotificationWindow?.();
          }, delayMs);
        };

        const applyProgressProfile = (text, pct) => {
          if (!container) return;
          const len = String(text || "").trim().length;
          const toneClass = len > 74 ? "is-long" : len > 40 ? "is-medium" : "is-short";
          container.classList.remove(...PROFILE_CLASSES, "is-active");
          container.classList.add(toneClass);
          if (pct >= 100) container.classList.add("is-complete");
          void container.offsetWidth;
          container.classList.add("is-active");
        };

        const tUi = (key, fallback) =>
          window.i18nUi && typeof window.i18nUi.getString === "function"
            ? window.i18nUi.getString(key, fallback)
            : fallback;
        async function resolveAchievementIcon(imgEl, cfgPath, rel) {
          try {
            const url = await window.api.resolveIconUrl(cfgPath, rel);
            imgEl.onerror = null;
            imgEl.src = url;
          } catch {
            imgEl.src = "assets/icon.png";
          }
        }

        window.api.onProgressUpdate(async (data) => {
          try {
            if (!data || !container || !titleEl || !imgEl || !fill) return;

            const name =
              typeof data.displayName === "object"
                ? data.displayName.english ||
                  Object.values(data.displayName).find(
                    (v) => typeof v === "string",
                  ) ||
                  tUi("progress.achievementFallback", "Achievement")
                : data.displayName ||
                  tUi("progress.achievementFallback", "Achievement");

            const cur = Number(data.progress ?? 0);
            const max = Number(data.max_progress ?? 0);
            const pct =
              max > 0 ? Math.min(100, Math.round((cur / max) * 100)) : 0;

            const title = `${name}: ${cur}/${max}`;
            titleEl.textContent = title;
            applyProgressProfile(title, pct);
            await resolveAchievementIcon(imgEl, data.config_path, data.icon);
            fill.style.width = `${pct}%`;
            scheduleClose(totalDurationMs);
          } catch (e) {
            console.error("[progress.html] render error:", e);
          }
        });

        scheduleClose(totalDurationMs);
      })();
    </script>
  </body>
</html>
