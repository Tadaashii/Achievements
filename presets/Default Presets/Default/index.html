<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Popup Animation</title>
    <meta name="duration" content="6000" />
    <meta width="450" height="115" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      body {
        transform-origin: center center;
      }
    </style>
  </head>
  <body>
    <div class="ach">
      <div class="icon"><img src="" alt="Icon" /></div>
      <div class="text_wrap">
        <p class="title"></p>
        <span class="detail"></span>
      </div>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const metaDur = document.querySelector('meta[name="duration"]');

        function startMarqueeIfOverflow(titleEl) {
          try {
            titleEl.getAnimations().forEach((a) => a.cancel());
          } catch {}
          titleEl.classList.remove("marquee");
          void titleEl.offsetWidth;
          const clip = titleEl.closest(".text_wrap") || titleEl;
          const overflow = Math.round(
            (titleEl.scrollWidth || 0) - (clip.clientWidth || 0)
          );
          if (overflow > 2) {
            const px = Math.ceil(overflow + 24);
            titleEl.classList.add("marquee");
            titleEl.animate(
              [
                { transform: "translateX(0)" },
                { transform: `translateX(-${px}px)` },
              ],
              {
                duration: Math.max(3000, Math.round(px / 50) * 1000),
                delay: 1000,
                easing: "linear",
                fill: "both",
              }
            );
          }
        }

        const baseTotal = Math.max(1, Number(metaDur?.content || 6000));

        function onPayload(displayName, description, iconPath, scale) {
          const ach = document.querySelector(".ach");
          const titleEl = document.querySelector(".title");
          const detailEl = document.querySelector(".detail");
          const iconEl = document.querySelector(".icon img");

          if (displayName != null) titleEl.textContent = displayName;
          if (description != null) detailEl.textContent = description;
          if (iconPath) {
            const p = String(iconPath);
            const normalized = p.replace(/\\/g, "/");
            iconEl.src = normalized.startsWith("file://")
              ? normalized
              : `file:///${normalized}`;
          }

          const s = Math.max(0.01, parseFloat(scale || 1) || 1);
          ach.style.setProperty("--scale", String(s));
          const total = Math.max(0, Number(metaDur?.content || baseTotal));
          const timelineScale = Math.max(0.1, total / baseTotal);
          const inMs = Math.max(120, Math.round(1400 * timelineScale));
          const outMs = Math.max(120, Math.round(400 * timelineScale));
          const holdMs = Math.max(0, total - inMs - outMs);
          ach.style.setProperty("--ach-in", `${inMs}ms`);
          ach.style.setProperty("--ach-hold", `${holdMs}ms`);
          ach.style.setProperty("--ach-out", `${outMs}ms`);

          // Start expand
          ach.classList.add("active");
          // After expand finishes (Default uses ~1.3s), measure + start marquee if needed
          setTimeout(() => {
            startMarqueeIfOverflow(titleEl);
            // small retry in case layout shifts
            setTimeout(() => startMarqueeIfOverflow(titleEl), 350);
          }, 900);

          setTimeout(() => {
            ach.classList.remove("active");
            window.api?.closeNotificationWindow?.();
          }, total);
        }

        // API path
        window.api?.onNotification?.((data) =>
          onPayload(
            data?.displayName,
            data?.description,
            data?.iconPath || data?.icon,
            data?.scale
          )
        );

        // Legacy electronAPI path
        window.electronAPI?.onNotification?.((data) =>
          onPayload(
            data?.displayName,
            data?.description,
            data?.icon || data?.iconPath,
            data?.scale
          )
        );
      });
    </script>
  </body>
</html>
