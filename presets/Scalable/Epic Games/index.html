<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Icon â†’ Panel (Docked)</title>
  <link rel="stylesheet" href="style.css" />

  <!-- App reads these -->
  <meta name="duration" content="5000" />
  <meta width="410" height="96" />

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background: transparent;
      display: flex; align-items: center; justify-content: center;
    }
    body { transform-origin: center center; }
  </style>
</head>
<body>
  <div class="dock" id="dock">
    <div class="icon" id="iconWrap">
      <img id="icon" alt="">
      <i class="seam"></i>
    </div>

    <div class="clip">
      <div class="text">
        <div class="title"><span class="title-inner" id="title"></span></div>
        <div class="desc"><span class="desc-inner" id="desc"></span></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const dock  = document.getElementById('dock');
      const icon  = document.getElementById('icon');
      const titleInner = document.getElementById('title');
      const descInner = document.getElementById('desc');
      const titleWrap = titleInner?.closest('.title');
      const descWrap = descInner?.closest('.desc');

      const metaDur = document.querySelector('meta[name="duration"]');
      const baseTotal = Math.max(1, Number(metaDur?.content || 5000));
      const MIN_TOTAL = 1200;

      // timeline
      const tIconIn   = 220;
      const tSlideL   = 320;
      const tOpen     = 260;
      const tClose    = 220;
      const tSlideBk  = 320;
      const tFadeOut  = 140;

      const marginEnd = 40;

      const dSlideL  = tIconIn;

      const computeTotal = () =>
        Math.max(MIN_TOTAL, Number(metaDur?.content || baseTotal));

      const applyTimeline = () => {
        const TOTAL = computeTotal();
        const timelineScale = Math.max(0.1, TOTAL / baseTotal);
        const sIconIn = Math.round(tIconIn * timelineScale);
        const sSlideL = Math.round(tSlideL * timelineScale);
        const sOpen = Math.round(tOpen * timelineScale);
        const sClose = Math.round(tClose * timelineScale);
        const sSlideBk = Math.round(tSlideBk * timelineScale);
        const sFadeOut = Math.round(tFadeOut * timelineScale);
        const sMargin = Math.round(marginEnd * timelineScale);

        let hold =
          TOTAL -
          (sIconIn + sSlideL + sOpen + sClose + sSlideBk + sFadeOut + sMargin);
        if (hold < 0) hold = 0;

        const dOpen = sIconIn + 0;
        const dClose = dOpen + sOpen + hold;
        const dSlideBk = dClose + sClose;
        const dFade = dSlideBk + sSlideBk;

        const setVar = (k, v) => dock.style.setProperty(k, v + "ms");
        setVar("--tIconIn", sIconIn);
        setVar("--tSlideL", sSlideL);
        setVar("--tOpen", sOpen);
        setVar("--tClose", sClose);
        setVar("--tSlideBk", sSlideBk);
        setVar("--tFade", sFadeOut);

        setVar("--dSlideL", dSlideL);
        setVar("--dOpen", dOpen);
        setVar("--dClose", dClose);
        setVar("--dSlideBk", dSlideBk);
        setVar("--dFade", dFade);
      };

      function fileUrl(p) {
        if (!p) return '';
        const s = String(p).replace(/\\/g, '/');
        return s.startsWith('file://') ? s : `file:///${s}`;
      }
      const safe = t => (t ?? '').toString().trim();

      const resetMarquee = (container, inner) => {
        if (!container || !inner) return;
        try {
          inner.getAnimations().forEach((a) => a.cancel());
        } catch {}
        container.classList.remove("marquee");
        void container.offsetWidth;
      };

      const applyMarquee = (container, inner, opts = {}) => {
        if (!container || !inner) return;
        const {
          minDuration = 3000,
          speedDivisor = 50,
          delay = 900,
          extraPadding = 24,
        } = opts;
        resetMarquee(container, inner);
        const overflow =
          (inner.scrollWidth || 0) - (container.clientWidth || 0);
        if (overflow > 2) {
          const px = Math.ceil(overflow + extraPadding);
          container.classList.add("marquee");
          inner.animate(
            [
              { transform: "translateX(0)" },
              { transform: `translateX(-${px}px)` },
            ],
            {
              duration: Math.max(
                minDuration,
                Math.round(px / speedDivisor) * 1000
              ),
              delay,
              easing: "linear",
              fill: "both",
            }
          );
        }
      };

      window.api?.onNotification?.((payload) => {
        icon.src = fileUrl(payload?.iconPath || '');
        titleInner.textContent = safe(payload?.displayName) || 'Achievement';
        const d = safe(payload?.description);
        descInner.textContent = d;
        if (descWrap) descWrap.style.display = d ? 'block' : 'none';

        applyTimeline();

        const scale = Math.max(0.01, Number(payload?.scale || 1));
        document.body.style.transform = `scale(${scale})`;
        if (scale > 1) document.body.dataset.scaled = "true"; else delete document.body.dataset.scaled;

        dock.classList.remove('active');
        void dock.offsetWidth;        
        dock.classList.add('active');

        requestAnimationFrame(() => {
          applyMarquee(titleWrap, titleInner, {
            minDuration: 2800,
            speedDivisor: 55,
            delay: 800,
          });
          if (d) {
            applyMarquee(descWrap, descInner, {
              minDuration: 2600,
              speedDivisor: 60,
              delay: 900,
            });
          } else {
            resetMarquee(descWrap, descInner);
          }
        });
      });
    })();
  </script>
</body>
</html>
